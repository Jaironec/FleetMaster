// Configuración de Prisma para PostgreSQL
// Sistema de Control de Transporte de Carga Pesada

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS - Estados y tipos predefinidos
// ============================================

enum RolUsuario {
  ADMIN   // Puede crear, editar, borrar
  AUDITOR // Solo lectura
}

enum EstadoVehiculo {
  ACTIVO
  EN_RUTA
  EN_MANTENIMIENTO
  INACTIVO
}

enum EstadoChofer {
  ACTIVO
  INACTIVO
}

enum ModalidadPago {
  POR_VIAJE
  MENSUAL
}

enum MetodoPago {
  EFECTIVO
  TRANSFERENCIA
  TARJETA
}

enum EstadoCliente {
  ACTIVO
  INACTIVO
}

enum EstadoViaje {
  PLANIFICADO
  EN_CURSO
  COMPLETADO
  CANCELADO
}

enum TipoMantenimiento {
  PREVENTIVO
  CORRECTIVO
}

enum EstadoMantenimiento {
  PENDIENTE     // Mantenimiento preventivo programado, aún no iniciado
  EN_CURSO      // Vehículo actualmente en taller
  COMPLETADO    // Mantenimiento finalizado
  CANCELADO     // Mantenimiento cancelado
}

enum TipoGasto {
  COMBUSTIBLE
  PEAJE
  ALIMENTACION
  HOSPEDAJE
  MULTA
  OTRO
}

enum TipoComprobante {
  GASTO_VIAJE
  MANTENIMIENTO
  PAGO_CHOFER
}

enum AccionAuditoria {
  CREAR
  EDITAR
  ELIMINAR
}

enum EstadoPagoCliente {
  PENDIENTE
  PARCIAL
  PAGADO
}

// NUEVO: Estado de pagos a choferes
enum EstadoPagoChofer {
  PENDIENTE   // Pago generado pero no efectuado
  PAGADO      // Pago realizado
}

// ============================================
// MODELOS PRINCIPALES
// ============================================

model Usuario {
  id            Int         @id @default(autoincrement())
  nombreUsuario String      @unique @map("nombre_usuario")
  email         String      @unique
  passwordHash  String      @map("password_hash")
  nombreCompleto String     @map("nombre_completo")
  rol           RolUsuario  @default(ADMIN)
  activo        Boolean     @default(true)
  creadoEn      DateTime    @default(now()) @map("creado_en")
  actualizadoEn DateTime    @updatedAt @map("actualizado_en")
  deletedAt     DateTime?   @map("deleted_at")

  // Relaciones
  registrosAuditoria RegistroAuditoria[]

  @@map("usuarios")
}

model Vehiculo {
  id                    Int             @id @default(autoincrement())
  placa                 String          @unique
  marca                 String
  modelo                String
  anio                  Int             @map("anio")
  tipo                  String          // Ej: "Trailer", "Cisterna", "Plataforma"
  capacidad             String          // Ej: "30 toneladas", "10000 litros"
  estado                EstadoVehiculo  @default(ACTIVO)
  kilometrajeActual     Int             @default(0) @map("kilometraje_actual")
  
  // Fechas importantes
  fechaUltimoMantenimiento DateTime?    @map("fecha_ultimo_mantenimiento")
  fechaProximoMantenimiento DateTime?   @map("fecha_proximo_mantenimiento")
  fechaVencimientoSoat     DateTime?    @map("fecha_vencimiento_soat")
  fechaVencimientoSeguro   DateTime?    @map("fecha_vencimiento_seguro")
  fechaVencimientoMatricula DateTime?   @map("fecha_vencimiento_matricula")
  observaciones         String?
  
  creadoEn              DateTime        @default(now()) @map("creado_en")
  actualizadoEn         DateTime        @updatedAt @map("actualizado_en")
  deletedAt             DateTime?       @map("deleted_at")

  // Relaciones (para futuras entregas)
  viajes                Viaje[]
  mantenimientos        Mantenimiento[]

  @@map("vehiculos")
}

model Chofer {
  id              Int           @id @default(autoincrement())
  nombres         String
  apellidos       String
  documentoId     String        @unique @map("documento_id") // Cédula o RUC
  telefono        String?
  fechaVencimientoLicencia DateTime? @map("fecha_vencimiento_licencia")
  correo          String?
  estado          EstadoChofer  @default(ACTIVO)
  
  // Configuración de pago
  modalidadPago   ModalidadPago @default(POR_VIAJE) @map("modalidad_pago")
  metodoPago      MetodoPago    @default(EFECTIVO) @map("metodo_pago")
  banco           String?       // Solo si es transferencia
  numeroCuenta    String?       @map("numero_cuenta")
  sueldoMensual   Decimal?      @map("sueldo_mensual") @db.Decimal(10, 2)
  
  // Configuración para pagos mensuales
  fechaContratacion DateTime?     @map("fecha_contratacion")  // Fecha de contratación (para calcular día de pago)
  diaPago           Int?          @map("dia_pago")            // Día del mes (calculado automáticamente)
  pagoQuincenal     Boolean       @default(false) @map("pago_quincenal") // Si también paga día 15
  
  creadoEn        DateTime      @default(now()) @map("creado_en")
  actualizadoEn   DateTime      @updatedAt @map("actualizado_en")
  deletedAt       DateTime?     @map("deleted_at")

  // Relaciones (para futuras entregas)
  viajes          Viaje[]
  pagos           PagoChofer[]

  @@map("choferes")
}

model Cliente {
  id              Int           @id @default(autoincrement())
  nombreRazonSocial String      @map("nombre_razon_social")
  documentoId     String        @unique @map("documento_id") // RUC o Cédula
  telefono        String?
  correo          String?
  direccion       String?
  sector          String?       // Sector comercial (opcional)
  estado          EstadoCliente @default(ACTIVO)
  
  creadoEn        DateTime      @default(now()) @map("creado_en")
  actualizadoEn   DateTime      @updatedAt @map("actualizado_en")
  deletedAt       DateTime?     @map("deleted_at")

  // Relaciones (para futuras entregas)
  viajes          Viaje[]

  @@map("clientes")
}

model Material {
  id              Int       @id @default(autoincrement())
  nombre          String    @unique
  unidadMedida    String    @map("unidad_medida") // litros, toneladas, etc.
  esPeligroso     Boolean   @default(false) @map("es_peligroso")
  descripcion     String?
  
  creadoEn        DateTime  @default(now()) @map("creado_en")
  actualizadoEn   DateTime  @updatedAt @map("actualizado_en")

  // Relaciones (para futuras entregas)
  viajes          Viaje[]

  @@map("materiales")
}

// ============================================
// MODELOS PARA FUTURAS ENTREGAS (Estructura definida)
// ============================================

model Viaje {
  id                  Int           @id @default(autoincrement())
  
  // Relaciones principales
  vehiculoId          Int           @map("vehiculo_id")
  vehiculo            Vehiculo      @relation(fields: [vehiculoId], references: [id])
  
  choferId            Int           @map("chofer_id")
  chofer              Chofer        @relation(fields: [choferId], references: [id])
  
  clienteId           Int           @map("cliente_id")
  cliente             Cliente       @relation(fields: [clienteId], references: [id])
  
  materialId          Int           @map("material_id")
  material            Material      @relation(fields: [materialId], references: [id])
  
  // Datos del viaje
  origen              String
  destino             String
  fechaSalida         DateTime      @map("fecha_salida")
  fechaLlegadaEstimada DateTime?    @map("fecha_llegada_estimada")
  fechaLlegadaReal    DateTime?     @map("fecha_llegada_real")
  
  kilometrosEstimados Int?          @map("kilometros_estimados")
  kilometrosReales    Int?          @map("kilometros_reales")
  
  tarifa              Decimal       @db.Decimal(10, 2) // Lo que se cobra al cliente
  
  // Campos de facturación/cobro
  estadoPagoCliente   EstadoPagoCliente @default(PENDIENTE) @map("estado_pago_cliente")
  montoPagadoCliente  Decimal       @default(0) @db.Decimal(10, 2) @map("monto_pagado_cliente")
  fechaLimitePago     DateTime?     @map("fecha_limite_pago")
  diasCredito         Int           @default(0) @map("dias_credito") // 0, 15, 30, 60
  
  montoPagoChofer     Decimal?      @db.Decimal(10, 2) @map("monto_pago_chofer") // Monto a pagar al chofer (solo para POR_VIAJE)
  estado              EstadoViaje   @default(PLANIFICADO)
  observaciones       String?
  
  creadoEn            DateTime      @default(now()) @map("creado_en")
  actualizadoEn       DateTime      @updatedAt @map("actualizado_en")

  // Relaciones
  gastos              GastoViaje[]
  pagos               PagoChofer[]

  @@index([vehiculoId])
  @@index([choferId])
  @@index([clienteId])
  @@index([fechaSalida])
  @@index([estado])
  @@index([estadoPagoCliente])
  @@map("viajes")
}

model GastoViaje {
  id              Int           @id @default(autoincrement())
  
  viajeId         Int           @map("viaje_id")
  viaje           Viaje         @relation(fields: [viajeId], references: [id])
  
  tipoGasto       TipoGasto     @map("tipo_gasto")
  monto           Decimal       @db.Decimal(10, 2)
  fecha           DateTime
  metodoPago      MetodoPago    @default(EFECTIVO) @map("metodo_pago")
  descripcion     String?
  
  // Relación con Comprobante (foto de factura/recibo)
  comprobanteId   Int?          @map("comprobante_id")
  comprobante     Comprobante?  @relation(fields: [comprobanteId], references: [id])
  
  creadoEn        DateTime      @default(now()) @map("creado_en")
  actualizadoEn   DateTime      @updatedAt @map("actualizado_en")

  @@index([viajeId])
  @@map("gastos_viaje")
}

model Comprobante {
  id                    Int               @id @default(autoincrement())
  
  tipo                  TipoComprobante   // GASTO_VIAJE, MANTENIMIENTO, PAGO_CHOFER
  referenciaId          Int?              @map("referencia_id") // ID del registro asociado (para referencia inversa)
  
  url                   String            // URL pública de Cloudinary
  publicId              String            @map("public_id") // ID interno de Cloudinary
  nombreArchivoOriginal String            @map("nombre_archivo_original")
  
  creadoEn              DateTime          @default(now()) @map("creado_en")

  // Relaciones
  gastosViaje           GastoViaje[]
  mantenimientos        Mantenimiento[]
  pagosChofer           PagoChofer[]

  @@map("comprobantes")
}

// ============================================
// MODULO MANTENIMIENTOS
// ============================================

model Mantenimiento {
  id                  Int               @id @default(autoincrement())
  
  vehiculoId          Int               @map("vehiculo_id")
  vehiculo            Vehiculo          @relation(fields: [vehiculoId], references: [id])
  
  tipo                TipoMantenimiento
  estado              EstadoMantenimiento @default(PENDIENTE)
  descripcion         String?
  taller              String?           // Nombre del taller (opcional al crear preventivo)
  esExterno           Boolean           @default(true) @map("es_externo")
  
  costoManoObra       Decimal           @default(0) @map("costo_mano_obra") @db.Decimal(10, 2)
  costoRepuestos      Decimal           @default(0) @map("costo_repuestos") @db.Decimal(10, 2)
  costoTotal          Decimal           @default(0) @map("costo_total") @db.Decimal(10, 2)
  
  fecha               DateTime          @map("fecha_mantenimiento")
  fechaInicio         DateTime?         @map("fecha_inicio")      // Cuando entró al taller
  fechaFin            DateTime?         @map("fecha_fin")         // Cuando salió del taller
  kilometrajeAlMomento Int?             @map("kilometraje_al_momento")
  proximaFecha        DateTime?         @map("proxima_fecha")
  proximoKilometraje  Int?              @map("proximo_kilometraje")
  
  // Relación con Comprobante
  comprobanteId       Int?              @map("comprobante_id")
  comprobante         Comprobante?      @relation(fields: [comprobanteId], references: [id])
  
  creadoEn            DateTime          @default(now()) @map("creado_en")
  actualizadoEn       DateTime          @updatedAt @map("actualizado_en")

  @@index([vehiculoId])
  @@index([estado])
  @@map("mantenimientos")
}

// ============================================
// MODULO PAGOS CHOFERES
// ============================================

model PagoChofer {
  id              Int         @id @default(autoincrement())
  
  choferId        Int         @map("chofer_id")
  chofer          Chofer      @relation(fields: [choferId], references: [id])
  
  monto           Decimal     @db.Decimal(10, 2)
  fecha           DateTime    @map("fecha_pago")  // Fecha programada/esperada
  metodoPago      MetodoPago  @default(EFECTIVO) @map("metodo_pago")
  descripcion     String?     // Ej: "Pago viajes noviembre"
  
  // NUEVO: Estado del pago
  estado          EstadoPagoChofer @default(PENDIENTE)
  fechaPagoReal   DateTime?   @map("fecha_pago_real")  // Fecha efectiva del pago
  
  // Relación con Comprobante
  comprobanteId   Int?              @map("comprobante_id")
  comprobante     Comprobante?      @relation(fields: [comprobanteId], references: [id])
  
  // Relación con Viaje (Opcional, si el pago es POR_VIAJE)
  viajeId         Int?              @map("viaje_id")
  viaje           Viaje?            @relation(fields: [viajeId], references: [id])

  
  creadoEn        DateTime    @default(now()) @map("creado_en")
  actualizadoEn   DateTime    @updatedAt @map("actualizado_en")

  @@index([choferId])
  @@index([fecha])
  @@map("pagos_choferes")
}

// ============================================
// AUDITORÍA - Registro de todos los cambios
// ============================================

model RegistroAuditoria {
  id              Int             @id @default(autoincrement())
  
  usuarioId       Int             @map("usuario_id")
  usuario         Usuario         @relation(fields: [usuarioId], references: [id])
  
  accion          AccionAuditoria // CREAR, EDITAR, ELIMINAR
  entidad         String          // Nombre de la tabla: "Vehiculo", "Chofer", etc.
  entidadId       Int             @map("entidad_id") // ID del registro afectado
  
  // Datos del cambio en formato JSON
  datosAnteriores Json?           @map("datos_anteriores") // Valores antes del cambio
  datosNuevos     Json?           @map("datos_nuevos")     // Valores después del cambio
  
  fechaHora       DateTime        @default(now()) @map("fecha_hora")
  ipAddress       String?         @map("ip_address")

  @@index([entidad, entidadId])
  @@index([usuarioId])
  @@index([fechaHora])
  @@map("registros_auditoria")
}
